# -*- coding: utf-8 -*-
"""Untitled11.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1zmnE2PDAUQ1qtohTYWvdeZ2GUMfMfSPb
"""

# Commented out IPython magic to ensure Python compatibility.
# %%writefile app.py
# import streamlit as st
# import streamlit as st
# import numpy as np
# import pandas as pd
# from sklearn.ensemble import RandomForestRegressor
# from sklearn.model_selection import train_test_split
# import folium
# from streamlit_folium import st_folium

-m pip install streamlit
-m pip install streamlit-folium

import streamlit as st
import pandas as pd
import numpy as np
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestRegressor
import folium
from streamlit_folium import st_folium

st.set_page_config(page_title="Air Quality Prediction & Monitoring",
                   layout="wide",
                   page_icon="üåç")

st.title("üåç Air Quality Prediction & Monitoring")
st.write("Predict air pollution & view health-safe routes in your city.")

st.sidebar.header(r"C:\Users\Rewati\OneDrive\Desktop\new\final_converted.csv")
uploaded = st.sidebar.file_uploader("Upload CSV containing air quality data", type=["csv"])

def train_model(df):
    df = df.dropna()

    feature_cols = [c for c in df.columns if c not in ["AQI", "PM2.5", "PM10"]]
    target = "AQI" if "AQI" in df.columns else df.columns[-1]

    X = df[feature_cols]
    y = df[target]

    X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

    model = RandomForestRegressor(n_estimators=120, random_state=42)
    model.fit(X_train, y_train)
    return model, feature_cols, target

model = None
feature_cols = []
target_col = ""

if uploaded:
    st.success("Dataset loaded successfully!")
    df = pd.read_csv(uploaded)
    st.write("### Preview of Uploaded Data")
    st.dataframe(df.head())

    try:
        model, feature_cols, target_col = train_model(df)
        st.success(f"Model trained to predict: **{target_col}**")
    except:
        st.error("Dataset format incorrect. Ensure it contains numeric columns.")

else:
    st.info("No dataset uploaded. Using default synthetic sample for demo.")
    df = pd.DataFrame({
        "Temperature": np.random.uniform(15, 40, 400),
        "Humidity": np.random.uniform(10, 90, 400),
        "WindSpeed": np.random.uniform(0.5, 12, 400),
        "AQI": np.random.uniform(20, 200, 400)
    })
    model, feature_cols, target_col = train_model(df)

st.subheader("üîÆ Predict Air Quality")

inputs = {}
cols = st.columns(len(feature_cols))
for i, c in enumerate(feature_cols):
    inputs[c] = cols[i].number_input(f"Enter {c}", float(df[c].min()), float(df[c].max()), float(df[c].mean()))

input_df = pd.DataFrame([inputs])
prediction = model.predict(input_df)[0]

st.metric(label=f"Predicted {target_col}", value=f"{prediction:.2f}")

st.subheader("üó∫Ô∏è Health-Safe Routes Based on Air Quality (Unique Feature!)")

st.write("This feature uses **synthetic air quality grid data** to generate the safest walking/driving route with the cleanest air quality.")

# create synthetic heatmap grid
map_center = [19.0760, 72.8777]  # Mumbai default

m = folium.Map(location=map_center, zoom_start=12)

heat_data = []
for lat in np.linspace(19.0, 19.15, 6):
    for lon in np.linspace(72.80, 73.00, 6):
        aqi = np.random.randint(30, 180)
        heat_data.append([lat, lon, aqi])

# add points
for point in heat_data:
    color = "green" if point[2] < 80 else "orange" if point[2] < 120 else "red"
    folium.CircleMarker(
        location=[point[0], point[1]],
        radius=7,
        color=color,
        fill=True,
        fill_color=color,
        popup=f"AQI: {point[2]}"
    ).add_to(m)

# simulated cleanest route
route = [
    [19.05, 72.84],
    [19.07, 72.86],
    [19.09, 72.88],
    [19.11, 72.90]
]
folium.PolyLine(route, color="blue", weight=5, tooltip="Cleanest Route").add_to(m)

st_map = st_folium(m, width=900, height=500)

st.success("Generated a health-safe path through the cleanest zones in the city!")

# ------------------------------
# FOOTER
# ------------------------------
st.write("---")
st.caption("Built with ‚ù§Ô∏è using Streamlit & Random Forest")


# -*- coding: utf-8 -*-
"""Untitled11.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1zmnE2PDAUQ1qtohTYWvdeZ2GUMfMfSPb
"""

import streamlit as st
import streamlit as st
import numpy as np
import pandas as pd
from sklearn.ensemble import RandomForestRegressor
from sklearn.model_selection import train_test_split
import folium
from streamlit_folium import st_folium

import streamlit as st
import numpy as np
import pandas as pd
from sklearn.ensemble import RandomForestRegressor
from sklearn.model_selection import train_test_split
import folium
from streamlit_folium import st_folium

# ------------------------------
# PAGE SETTINGS
# ------------------------------
st.set_page_config(page_title="Air Quality Prediction & Monitoring",
                   layout="wide",
                   page_icon="üåç")

st.title("üåç Air Quality Prediction & Monitoring")
st.write("Predict air pollution & view health-safe routes in Delhi.")

# ------------------------------
# SIDEBAR: UPLOAD DATASET
# ------------------------------
st.sidebar.header("üìÅ Upload Your Dataset")
uploaded = st.sidebar.file_uploader("Upload CSV containing air quality data", type=["csv"])

# ------------------------------
# MODEL TRAINING FUNCTION
# ------------------------------
def train_model(df):
    df = df.dropna()

    feature_cols = [c for c in df.columns if c not in ["AQI", "PM2.5", "PM10"]]
    target = "AQI" if "AQI" in df.columns else df.columns[-1]

    X = df[feature_cols]
    y = df[target]

    X_train, X_test, y_train, y_test = train_test_split(
        X, y, test_size=0.2, random_state=42
    )

    model = RandomForestRegressor(n_estimators=120, random_state=42)
    model.fit(X_train, y_train)

    return model, feature_cols, target

# ------------------------------
# LOAD OR SIMULATE DATA
# ------------------------------
model = None
feature_cols = []
target_col = ""

if uploaded:
    st.success("Dataset uploaded successfully!")
    df = pd.read_csv(uploaded)
    st.write("### Preview of Uploaded Data")
    st.dataframe(df.head())

    try:
        model, feature_cols, target_col = train_model(df)
        st.success(f"Model trained to predict: **{target_col}**")
    except:
        st.error("Dataset format incorrect. Ensure numeric columns are present.")

else:
    st.info("No dataset uploaded. Using synthetic Delhi dataset for demo.")
    df = pd.DataFrame({
        "Temperature": np.random.uniform(10, 45, 400),
        "Humidity": np.random.uniform(10, 90, 400),
        "WindSpeed": np.random.uniform(0.5, 12, 400),
        "AQI": np.random.uniform(50, 350, 400)
    })
    model, feature_cols, target_col = train_model(df)

# ------------------------------
# PREDICTION SECTION
# ------------------------------
st.subheader("üîÆ Predict Air Quality")

inputs = {}
cols = st.columns(len(feature_cols))
for i, c in enumerate(feature_cols):
    inputs[c] = cols[i].number_input(
        f"Enter {c}", float(df[c].min()), float(df[c].max()), float(df[c].mean())
    )

input_df = pd.DataFrame([inputs])
prediction = model.predict(input_df)[0]

st.metric(label=f"Predicted {target_col}", value=f"{prediction:.2f}")

# ------------------------------
# WOW FACTOR: CLEANEST ROUTE MAP (Delhi)
# ------------------------------
st.subheader("üó∫Ô∏è Delhi Clean-Air Route (Unique Feature!)")

st.write(
    "This feature simulates Delhi‚Äôs AQI grid and finds a **cleaner route** "
    "to walk/drive safely."
)

# Delhi map center
delhi_center = [28.6139, 77.2090]

m = folium.Map(location=delhi_center, zoom_start=11)

# synthetic AQI grid for Delhi
heat_data = []
for lat in np.linspace(28.50, 28.75, 7):
    for lon in np.linspace(77.10, 77.35, 7):
        aqi = np.random.randint(60, 300)
        heat_data.append([lat, lon, aqi])

# add colored circles
for point in heat_data:
    color = "green" if point[2] < 100 else "orange" if point[2] < 180 else "red"
    folium.CircleMarker(
        location=[point[0], point[1]],
        radius=6,
        color=color,
        fill=True,
        fill_color=color,
        popup=f"AQI: {point[2]}"
    ).add_to(m)

# cleanest synthetic route in Delhi
clean_route = [
    [28.55, 77.12],
    [28.58, 77.16],
    [28.60, 77.19],
    [28.62, 77.25]
]

folium.PolyLine(clean_route, color="blue", weight=5,
                tooltip="Cleanest Route in Delhi").add_to(m)

st_folium(m, width=900, height=500)

st.success("Clean-air route generated successfully!")

# ------------------------------
# FOOTER
# ------------------------------
st.write("---")
st.caption("Built with ‚ù§Ô∏è using Streamlit & Random Forest")

